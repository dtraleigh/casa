{% extends 'base.html' %}
{% load static %}

{% block title %}Wemo Controls - Casa{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="col-12 col-lg-10">
                <div class="mb-4">
                    <!-- Header - full width on all screens -->
                    <h2 class="mb-3">Wemo Smart Plug Controls</h2>

                    <!-- Controls - stack on mobile, horizontal on larger screens -->
                    <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-3">
                        <!-- Away Mode Toggle -->
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="away-mode-toggle" {% if away_mode_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="away-mode-toggle">
                                <i class="fas fa-plane-departure me-1"></i>
                                Away Mode
                            </label>
                        </div>

                        <div class="text-muted">
                            <small>
                                {{ online_count }} of {{ total_switches }} devices online
                            </small>
                        </div>

                        <button class="btn btn-outline-primary" id="discover-btn">
                            <i class="fas fa-search me-2"></i>
                            Discover Devices
                        </button>
                    </div>
                </div>
            </div>

            <!-- Away Mode Info Card -->
            <div class="card shadow-sm mb-3 {% if away_mode_enabled %}border-primary{% endif %}" id="away-mode-info" style="{% if not away_mode_enabled %}display: none;{% endif %}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-2">
                                <i class="fas fa-plane-departure text-primary me-2"></i>
                                Away Mode Active
                            </h6>
                            <small class="text-muted" id="away-mode-details">
                                Loading schedule information...
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-primary">Automated Control Enabled</span>
                        </div>
                    </div>
                </div>
            </div>

            {% if switch_data %}
                <div class="row g-3">
                    {% for data in switch_data %}
                    <div class="col-12 col-md-6 col-xl-4">
                        <div class="card shadow-sm h-100 {% if not data.online %}border-secondary{% elif data.is_on %}border-success{% else %}border-light{% endif %}"
                             data-switch-id="{{ data.switch.id }}">

                            <!-- Card Header -->
                            <div class="card-header {% if not data.online %}bg-light text-muted{% elif data.is_on %}bg-success text-white{% else %}bg-light{% endif %}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 fw-bold">{{ data.switch.name }}</h6>
                                    <div class="status-indicators">
                                        <!-- Online/Offline indicator -->
                                        <span class="badge {% if data.online %}bg-success{% else %}bg-secondary{% endif %} me-1">
                                            {% if data.online %}
                                                <i class="fas fa-wifi"></i> Online
                                            {% else %}
                                                <i class="fas fa-exclamation-triangle"></i> Offline
                                            {% endif %}
                                        </span>

                                        <!-- Power state indicator -->
                                        {% if data.online %}
                                            <span class="badge {% if data.is_on %}bg-warning text-dark{% else %}bg-dark{% endif %}">
                                                {% if data.is_on %}
                                                    <i class="fas fa-power-off"></i> ON
                                                {% else %}
                                                    <i class="fas fa-power-off"></i> OFF
                                                {% endif %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body">
                                <!-- Device Info -->
                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-network-wired me-1"></i>
                                        {{ data.switch.ip_address }}
                                        {% if data.switch.hostname %}
                                            ({{ data.switch.hostname }})
                                        {% endif %}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        Last seen: <span class="last-seen-time">{{ data.switch.last_seen|date:"M d, Y H:i" }}</span>
                                    </small>
                                </div>

                                <!-- Controls -->
                                {% if data.online %}
                                    <div class="d-grid gap-2">
                                        <button class="btn {% if data.is_on %}btn-warning{% else %}btn-success{% endif %} toggle-btn"
                                                data-switch-id="{{ data.switch.id }}"
                                                data-current-state="{{ data.current_state }}">
                                            <i class="fas fa-power-off me-2"></i>
                                            {% if data.is_on %}Turn Off{% else %}Turn On{% endif %}
                                        </button>

                                        <button class="btn btn-outline-secondary btn-sm refresh-btn"
                                                data-switch-id="{{ data.switch.id }}">
                                            <i class="fas fa-sync-alt me-1"></i>
                                            Refresh Status
                                        </button>
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning mb-2" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <small>Device is offline or unreachable. Controls are disabled.</small>
                                    </div>
                                    <div class="d-grid">
                                        <button class="btn btn-secondary" disabled>
                                            <i class="fas fa-power-off me-2"></i>
                                            Controls Disabled
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm refresh-btn mt-2"
                                                data-switch-id="{{ data.switch.id }}">
                                            <i class="fas fa-sync-alt me-1"></i>
                                            Try Reconnect
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-plug fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Wemo Devices Found</h5>
                        <p class="text-muted">
                            No enabled Wemo switches are configured.
                            <br>
                            Run the discovery command to find devices on your network.
                        </p>
                        <code>python manage.py discover_wemo</code>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Discovery Results Modal -->
<div class="modal fade" id="discoveryModal" tabindex="-1" aria-labelledby="discoveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="discoveryModalLabel">
                    <i class="fas fa-search me-2"></i>Device Discovery Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="discovery-results">
                <!-- Results will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="location.reload()">Refresh Page</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle text-primary me-2"></i>
            <strong class="me-auto">Wemo Control</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toastEl = document.getElementById('notification-toast');
    const toast = new bootstrap.Toast(toastEl);

    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Away Mode functionality
    const awayModeToggle = document.getElementById('away-mode-toggle');
    const awayModeInfo = document.getElementById('away-mode-info');
    const awayModeDetails = document.getElementById('away-mode-details');

    // Fetch and display away mode status
    function updateAwayModeInfo() {
        fetch('/wemo/away-mode/status/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    awayModeDetails.innerHTML = `
                        <strong>Sunset window:</strong> ${data.sunset_window}<br>
                        <strong>Off time window:</strong> ${data.off_window}<br>
                        <small class="text-muted">Lights will turn on randomly around ${data.sunset_time} and off around ${data.off_time}</small>
                    `;
                }
            })
            .catch(error => console.error('Error fetching away mode status:', error));
    }

    // Update info on page load if away mode is enabled
    if (awayModeToggle.checked) {
        updateAwayModeInfo();
    }

    // Handle away mode toggle
    awayModeToggle.addEventListener('change', function() {
        const isEnabled = this.checked;

        fetch('/wemo/away-mode/toggle/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message);

                // Show/hide info card
                if (data.enabled) {
                    awayModeInfo.style.display = 'block';
                    awayModeInfo.classList.add('border-primary');
                    updateAwayModeInfo();
                } else {
                    awayModeInfo.style.display = 'none';
                    awayModeInfo.classList.remove('border-primary');
                }
            } else {
                showNotification(data.error || 'Failed to toggle Away Mode', true);
                // Revert toggle on error
                this.checked = !isEnabled;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error occurred', true);
            // Revert toggle on error
            this.checked = !isEnabled;
        });
    });

    function formatDateTime(date) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        const hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;

        return `${month} ${day}, ${year} ${displayHours}:${minutes} ${ampm}`;
    }

    function showNotification(message, isError = false) {
        const toastBody = toastEl.querySelector('.toast-body');
        const toastIcon = toastEl.querySelector('.toast-header i');

        toastBody.textContent = message;

        if (isError) {
            toastIcon.className = 'fas fa-exclamation-triangle text-danger me-2';
        } else {
            toastIcon.className = 'fas fa-check-circle text-success me-2';
        }

        toast.show();
    }

    function updateSwitchCard(switchId, data) {
        const card = document.querySelector(`[data-switch-id="${switchId}"]`);
        if (!card) return;

        const header = card.querySelector('.card-header');
        const toggleBtn = card.querySelector('.toggle-btn');
        const statusBadges = card.querySelector('.status-indicators');
        const lastSeenSpan = card.querySelector('.last-seen-time');

        if (data.online) {
            // Update online status
            card.className = card.className.replace(/border-\w+/, data.is_on ? 'border-success' : 'border-light');
            header.className = data.is_on ? 'card-header bg-success text-white' : 'card-header bg-light';

            // Update toggle button
            if (toggleBtn) {
                toggleBtn.className = `btn ${data.is_on ? 'btn-warning' : 'btn-success'} toggle-btn`;
                toggleBtn.innerHTML = `<i class="fas fa-power-off me-2"></i>${data.is_on ? 'Turn Off' : 'Turn On'}`;
                toggleBtn.dataset.currentState = data.current_state;
                toggleBtn.disabled = false;
            }

            // Update status badges
            statusBadges.innerHTML = `
                <span class="badge bg-success me-1">
                    <i class="fas fa-wifi"></i> Online
                </span>
                <span class="badge ${data.is_on ? 'bg-warning text-dark' : 'bg-dark'}">
                    <i class="fas fa-power-off"></i> ${data.is_on ? 'ON' : 'OFF'}
                </span>
            `;
        } else {
            // Update offline status
            card.className = card.className.replace(/border-\w+/, 'border-secondary');
            header.className = 'card-header bg-light text-muted';

            if (toggleBtn) {
                toggleBtn.disabled = true;
            }

            statusBadges.innerHTML = `
                <span class="badge bg-secondary me-1">
                    <i class="fas fa-exclamation-triangle"></i> Offline
                </span>
            `;
        }

        // Update last seen time
        if (data.last_seen && lastSeenSpan) {
            const date = new Date(data.last_seen);
            lastSeenSpan.textContent = formatDateTime(date);
        }
    }

    // Discovery button handler
    document.getElementById('discover-btn').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Discovering...';

        fetch('/wemo/discover/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDiscoveryResults(data);
                showNotification(data.message);
            } else {
                showNotification(data.error || 'Discovery failed', true);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error during discovery', true);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });

    function showDiscoveryResults(data) {
        const modal = new bootstrap.Modal(document.getElementById('discoveryModal'));
        const resultsDiv = document.getElementById('discovery-results');

        let html = `
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">${data.discovered}</h5>
                            <p class="card-text">Devices Found</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">${data.new}</h5>
                            <p class="card-text">New Devices</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">${data.updated}</h5>
                            <p class="card-text">Updated Devices</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        if (data.details && data.details.length > 0) {
            html += '<h6>Device Details:</h6><div class="list-group">';

            data.details.forEach(detail => {
                let badgeClass, iconClass, message;

                if (detail.action === 'added') {
                    badgeClass = 'bg-success';
                    iconClass = 'fa-plus';
                    message = `Added: ${detail.name} (${detail.ip})`;
                } else if (detail.action === 'updated') {
                    badgeClass = 'bg-warning text-dark';
                    iconClass = 'fa-sync-alt';
                    message = `Updated: ${detail.name}`;
                    if (detail.changes.length > 0) {
                        message += `<br><small>${detail.changes.join(', ')}</small>`;
                    }
                } else if (detail.action === 'unchanged') {
                    badgeClass = 'bg-secondary';
                    iconClass = 'fa-check';
                    message = `Unchanged: ${detail.name} (${detail.ip})`;
                } else if (detail.action === 'error') {
                    badgeClass = 'bg-danger';
                    iconClass = 'fa-exclamation-triangle';
                    message = `Error: ${detail.name} - ${detail.error}`;
                }

                html += `
                    <div class="list-group-item">
                        <span class="badge ${badgeClass} me-2">
                            <i class="fas ${iconClass}"></i>
                        </span>
                        ${message}
                    </div>
                `;
            });

            html += '</div>';
        }

        resultsDiv.innerHTML = html;
        modal.show();
    }

    // Toggle switch handler
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('toggle-btn') || e.target.closest('.toggle-btn')) {
            const btn = e.target.classList.contains('toggle-btn') ? e.target : e.target.closest('.toggle-btn');
            const switchId = btn.dataset.switchId;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            fetch(`/wemo/toggle/${switchId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSwitchCard(switchId, data);
                    showNotification(data.message);
                } else {
                    showNotification(data.error || 'Failed to toggle switch', true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error occurred', true);
            })
            .finally(() => {
                btn.disabled = false;
            });
        }
    });

    // Refresh status handler
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('refresh-btn') || e.target.closest('.refresh-btn')) {
            const btn = e.target.classList.contains('refresh-btn') ? e.target : e.target.closest('.refresh-btn');
            const switchId = btn.dataset.switchId;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';

            fetch(`/wemo/refresh/${switchId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSwitchCard(switchId, data);
                    showNotification('Status refreshed');
                } else {
                    showNotification(data.error || 'Failed to refresh status', true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error occurred', true);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Status';
            });
        }
    });
});
</script>
{% endblock %}